name: Compare namespaces within Terraform, matches directory namespace

on:
  pull_request:
    paths:
      - 'namespaces/live.cloud-platform.service.justice.gov.uk/**'
      - 'namespaces/live-2.cloud-platform.service.justice.gov.uk/**'
  workflow_dispatch:

env:
  GITHUB_OAUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  compare-namespaces:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - id: compare-namespace
        name: Check PR user 
        uses: jackstockley89/cloud-platform-environments/cmd/compare-namespace@main
    
      - name: Comment Mismatch to Pull Request
        uses: actions/github-script@v6
        if: steps.compare-namespace.outputs.mismatch == 'true'
        env:
            MISMATCH: "${{ steps.compare-namespace.outputs.*, \n }}"
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${process.env.MISMATCH}`
            });
